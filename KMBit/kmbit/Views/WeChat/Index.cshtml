@model KMBit.Models.WeChatChargeModel
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_weChatLayout.cshtml";
    string message = "";
    if (ViewBag.Message != null)
    {
        message = (string)ViewBag.Message;
    }
}

@using GridMvc.Html
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
<script type="text/javascript">
    var BASE_URL = '@Url.Content("~/")';
    $(function () {
        //GetMobileLocation("18606204852", function (data) {
        //    alert(data.sp);
        //});

        //$('#ChargeForm').find('#Mobile').blur(function () {
        //    GetMobileLocation($('#ChargeForm').find('#Mobile').val(), function (data) {
        //        if (data == null) {
        //            alert("请输入正确的手机号码");
        //            return;
        //        } else {
        //            $('#ChargeForm').find('#SPName').val(data.sp);
        //            $('#ChargeForm').find('#Province').val(data.province);
        //            $('#ChargeForm').find('#City').val(data.city);
        //            $('#ChargeForm').find('#SPName').val(data.sp);
        //        }
        //    });
        //});

        $('#ChargeForm').find('#global_byte').click(function () {
            var mobileNumber = $('#ChargeForm').find('#Mobile').val();
            if ($.trim(mobileNumber) == '') {
                $('#ChargeForm').submit();
                return;
            }
            if ($('#ChargeForm').find('#SPName').val() != '') {
                requestTaocan($('#ChargeForm').find('#SPName').val(), $('#ChargeForm').find('#Province').val(),'global');
            } else {
                GetMobileLocation($('#ChargeForm').find('#Mobile').val(), function (data) {
                    if (data == null) {
                        alert("请输入正确的手机号码");
                        return;
                    } else {
                        $('#ChargeForm').find('#SPName').val(data.sp);
                        $('#ChargeForm').find('#Province').val(data.province);
                        $('#ChargeForm').find('#City').val(data.city);
                        $('#ChargeForm').find('#SPName').val(data.sp);
                        requestTaocan($('#ChargeForm').find('#SPName').val(), $('#ChargeForm').find('#Province').val(),'global');
                    }
                });
            }
        });
        $('#ChargeForm').find('#local_byte').click(function () {
            var mobileNumber = $('#ChargeForm').find('#Mobile').val();
            if ($.trim(mobileNumber) == '') {
                $('#ChargeForm').submit();
                return;
            }

            if ($('#ChargeForm').find('#SPName').val() != '') {
                requestTaocan($('#ChargeForm').find('#SPName').val(), $('#ChargeForm').find('#Province').val(),'local');
            } else {
                GetMobileLocation($('#ChargeForm').find('#Mobile').val(), function (data) {
                    if (data == null) {
                        alert("请输入正确的手机号码");
                        return;
                    } else {
                        $('#ChargeForm').find('#SPName').val(data.sp);
                        $('#ChargeForm').find('#Province').val(data.province);
                        $('#ChargeForm').find('#City').val(data.city);
                        $('#ChargeForm').find('#SPName').val(data.sp);
                        requestTaocan($('#ChargeForm').find('#SPName').val(), $('#ChargeForm').find('#Province').val(),'local');
                    }
                });
            }

        });


        function requestTaocan(sp, province,scope) {
            $.post(
                        BASE_URL + "api/Product/SearchDirectChargeTaocans",
                        { sp: sp, province: province, scope: scope },
                        function (data) {
                            $('#taocan_container').html("");
                            var ul = $('<ul style="padding-left:0px;"></ul>');
                            if (data.Status == "OK" && data.Item.length > 0) {
                                $(data.Item).each(function (index, item) {
                                    var li = $("<li style=\"overflow:hidden;display:block;\"></li>").appendTo(ul);
                                    var chkDiv = $("<div style=\"float:left;width:5%;\"></div>").appendTo(li);
                                    $('<input type="radio" id="ResourceTaocanId" name="ResourceTaocanId" value="' + item.Taocan.Id + '"/>').appendTo(chkDiv);
                                    $("<div style=\"float:left;width:15%;\"></div>").appendTo(li).html(item.Taocan2.Name);
                                    //$("<div style=\"float:left;width:10%;\"></div>").appendTo(li).html(item.Taocan.Quantity);
                                    $("<div style=\"float:left;width:5%;\"></div>").appendTo(li).html(item.Taocan.Sale_price+"元");
                                });
                            }
                            $(ul).appendTo($('#taocan_container'))
                        }
                    );
        }

        $('#ChargeForm').find('#submit_charge').click(function () {
            var mobileNumber = $('#ChargeForm').find('#Mobile').val();
            if ($.trim(mobileNumber) == '') {
                $('#ChargeForm').submit();
                return;
            }
            var taocanId = $('#ChargeForm').find('#taocan_container').find('input[name="ResourceTaocanId"]:checked').val();
            if (taocanId=="undefined" || $.trim(taocanId) == '' || taocanId == 0) {
                alert("请选择需要充值的流量包套餐");
                return;
            }

            $.post(
                BASE_URL + "WeChat/PreCharge",
                {
                    SPName: $('#ChargeForm').find('#SPName').val(),
                    Province: $('#ChargeForm').find('#Province').val(),
                    City: $('#ChargeForm').find('#City').val(),
                    OpenId: $('#ChargeForm').find('#OpenId').val(),
                    nancestr: $('#ChargeForm').find('#nancestr').val(),
                    timestamp: $('#ChargeForm').find('#timestamp').val(),
                    Mobile: $('#ChargeForm').find('#Mobile').val(),
                    ResourceTaocanId: $('#ChargeForm').find('#ResourceTaocanId').val(),
                },
                function (data) {
                    if (data != 'undefined' && typeof (data) == 'object') {                        
                        if (data.Status == "OK") {
                            alert(data.Item.timestamp + "|" + data.Item.nancestr + "|" + data.Item.prepay_id);
                            wx.chooseWXPay({
                                timestamp: data.Item.timestamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                                nonceStr: data.Item.nancestr, // 支付签名随机串，不长于 32 位
                                package: 'prepay_id='+data.Item.prepay_id, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                                signType: 'MD5', // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                                paySign: data.Item.paySign, // 支付签名
                                success: function (res) {
                                    alert(res);
                                }
                            });
                        } else {
                            alert(data.Message);
                        }
                    }
                }
            );
            //$('#ChargeForm').submit();
        })
        wx.config({
            debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: $('#ChargeForm').find('#appid').val(), // 必填，公众号的唯一标识
            timestamp: $('#ChargeForm').find('#timestamp').val(), // 必填，生成签名的时间戳
            nonceStr: $('#ChargeForm').find('#nancestr').val(), // 必填，生成签名的随机串
            signature: $('#ChargeForm').find('#signature').val(),// 必填，签名，见附录1
            jsApiList: [chooseWXPay] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });
        wx.ready(function () {
            
            // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
        });
        wx.error(function (res) {
            // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
            alert(res);
        });
    });
</script>

<h2>欢迎使用自助流量充值</h2>

@using (Html.BeginForm("PreCharge", "WeChat", FormMethod.Post, new {role = "form", @id = "ChargeForm" }))
{
    @Html.HiddenFor(model => model.SPName)
    @Html.HiddenFor(model => model.Province)
    @Html.HiddenFor(model => model.City)
    @Html.HiddenFor(model => model.OpenId)
    @Html.HiddenFor(model => model.appid)
    @Html.HiddenFor(model => model.nancestr)
    @Html.HiddenFor(model => model.timestamp)
    @Html.HiddenFor(model => model.signature)
    <div class="form-group">
        @Html.LabelFor(model => model.Mobile, htmlAttributes: new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.Mobile, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.Mobile, "", new { @class = "text-danger" })
        </div>
    </div>
    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <div class="btn-group" role="group" aria-label="...">
                <button id="global_byte" type="button" class="btn btn-default">全国流量</button>
                <button id="local_byte" type="button" class="btn btn-default">本地流量</button>
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <div id="taocan_container">

            </div>

        </div>
    </div>

    if (message != "")
    {
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <p style="color:red;">@Html.Raw(message)</p>
            </div>
        </div>
    }

    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <input id="submit_charge" type="button" value="充值" class="btn btn-default" />
        </div>
    </div>
}
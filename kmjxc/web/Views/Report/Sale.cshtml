@{
    ViewBag.Title = "销售报表";
}

<script>
    var reportManager = new KMJXCReportManager();
    var productMgr = new KMJXCProductManager();
    var paged = false;
    var pageSize=50;
    var pageHtml;
    var productsPageSize = 30;
    var selectedProducts = [];
    $(function () {
        $('#tabs').tabs();
        generateReports(1);

        $('#btnRptSubmit').button({ icons: { primary: "ui-icon-search" } }).click(function () {
            generateReports(1);
        });

        $('#btnSelectProducts').button({ icons: { primary: "ui-icon-plus" } }).click(function () {
            $('#popup_products').dialog({
                position: { my: "top", at: "top", of: $("#tabs") },
                width: 550,
                //height:550,
                resizable: false,
                title: "选择产品生成报表",
                modal: true,
                open: function () {
                    $('#ulProductList').html("");
                    getProducts(1);
                },
                close: function () { },
                buttons: [
                   {
                       text: "确定", click: function () {
                           var $ul = $('#ulSelectedProducts');
                           $ul.html("");
                           for (var i = 0; i < selectedProducts.length; i++) {
                               //alert(selectedProducts[i].name);
                               $("<li>" + selectedProducts[i].name + "</li>").appendTo($ul);
                           }
                           $ul.show();
                           $(this).dialog("close");
                       },
                       icons: { primary: "ui-icon-disk" }
                   },
                   {
                       text: "关闭", click: function () {
                           $(this).dialog("close");
                       },
                       icons: { primary: "ui-icon-close" }
                   }
                ]
            });
            $('#popup_products').dialog("open");
        });
       
        $('#rpt_StartDate').datepicker({
            currentText: "Now",
            dateFormat: "yy-mm-dd",
            showMonthAfterYear: true,
            changeMonth: true,
            changeYear: true,
            buttonImageOnly: true,
        });
        $('#rpt_EndDate').datepicker({
            currentText: "Now",
            dateFormat: "yy-mm-dd",
            showMonthAfterYear: true,
            changeMonth: true,
            changeYear: true,
            buttonImageOnly: true,
        });
    });

    function getProducts(page) {
        new ShowProgress("loadingProductPro", function () { }, "正在加载产品，请耐性等待...");
        Boxy.get($('#loadingProductPro')).show();
        productMgr.SearchProducts({ 'page': page, 'pageSize': productsPageSize }, function (res) {
            Boxy.get($('#loadingProductPro')).hide();
            var total = res.totalRecords;
            var data = res.data;
            var curPage = res.curPage;
            var $ul = $('#ulProductList');
            $ul.html("");
            var pageHtml = productMgr.Pager({ 'total': total, 'page': curPage, 'pageSize': productsPageSize, 'fun': 'getProducts' }, "spn", "pn");
            if (pageHtml != '') {              
                $('#productsListPager').html(pageHtml).show();
            } else {
                $('#productsListPager').html('').hide();
            }
            if (data != null && data.length > 0) {
                $(data).each(function (index, item) {
                    var $li = $("<li></li>").appendTo($ul);
                    var $chk = null;
                    var selected = false;
                    for (var i = 0; i < selectedProducts.length; i++) {
                        if (selectedProducts[i].id == item.ID) {
                            selected = true;
                            break;
                        }
                    }

                    if (!selected) {
                        $chk = $("<input value=\"" + item.ID + "\" style=\"vertical-align:middle;\" type=\"checkbox\"/>").appendTo($li);
                    } else {
                        $chk = $("<input value=\""+item.ID+"\" checked style=\"vertical-align:middle;\" type=\"checkbox\"/>").appendTo($li);
                    }

                    $chk.change(function () {
                        var tmp = [];
                        var checked=$(this).attr('checked');
                        var curId = $(this).attr('value');
                        var name = $(this).next().html();
                       
                        var newJson = { 'id': curId, 'name': name };
                        //if (selectedProducts.length <= 0) {
                        //    if (checked == 'checked') {
                        //        tmp.push(newJson);
                        //    }
                        //}

                        var existed = false;
                        for (var i = 0; i < selectedProducts.length; i++) {                           
                            if (selectedProducts[i].id == curId) {
                                existed = true;
                                if (checked == 'checked') {
                                    tmp.push(selectedProducts[i]);
                                }
                            } else {
                                tmp.push(selectedProducts[i]);
                            }
                        }

                        if (!existed) {
                            if (checked == 'checked') {
                                tmp.push(newJson);
                            }
                        }

                        selectedProducts = tmp;
                    });
                    $("<span>" + item.Title + "</span>").appendTo($li);
                });

                $ul.show();
            }
        });
    }


    function generateReports(page) {

        var sdate = $('#rpt_StartDate').val();
        var edate = $('#rpt_EndDate').val();

        sdate = $.GetUnixTime(sdate);
        edate = $.GetUnixTime(edate);
        var pdtIds = "";

        for (var i = 0; i < selectedProducts.length; i++) {
            if (pdtIds == "") {
                pdtIds = selectedProducts[i].id;
            } else {
                pdtIds += ","+selectedProducts[i].id;
            }
        }
        
        reportManager.GetSalesReport({'stime':sdate,'etime':edate,'products':pdtIds}, function (res) {
            $('#rptPivot').html("");
            var row = res.data;
            if (row == null || row.length == 0) {
                return;
            }

            if (!paged) {
                pageHtml = reportManager.Pager({ 'page': page, 'total': res.totalRecords, 'pageSize': pageSize, 'fun': generateReports });
                paged = true;
                if (pageHtml != '') {
                    $('#rptPivotPager').html(pageHtml);
                }
            }

            var JSONdata = {
                dataid: 'An optional sourcetable identifier',
                columns: [
                    { colvalue: 'ProductName', coltext: 'ProductName', header: '产品', sortbycol: 'ProductName', groupbyrank: 1, pivot: true, result: false },
                    { colvalue: 'PropName', coltext: 'PropName', header: '属性', sortbycol: 'ShopName', groupbyrank: 2, pivot: false, result: false },
                    { colvalue: 'Month', coltext: 'Month', header: '月份', sortbycol: 'Month', groupbyrank: null, pivot: true, result: false },
                    { colvalue: 'Quantity', coltext: '数量', header: '数量', sortbycol: 'Quantity', groupbyrank: null, pivot: false, result: true },
                    { colvalue: 'Amount', coltext: '金额', header: '金额', sortbycol: 'Amount', groupbyrank: null, pivot: false, result: true }
                ],
                rows: row
            };

            $('#rptPivot').pivot({
                source: JSONdata,
                formatFunc: function (n) {
                    return n;
                    //return jQuery.fn.pivot.formatDK(n, 2);
                },
                parseNumFunc: function (n) {
                    return +((typeof n === 'string') ? n.replace('.', '').replace(',', '.') : n);
                },
                onResultCellClicked: function (data) {
                    alert(dumpObj(data, 'data'));
                }
            });
        });
    }
</script>

<div id="tabs">
    <ul>
        <li><a href="#reports">销售报表</a></li>
    </ul>
    <div id="reports">  
        <div id="rptFilter" style="padding-bottom:10px;">
            <div class="rowS"><label>时间范围:</label><input id="rpt_StartDate" class="W_input" readonly="true"/>  至  <input id="rpt_EndDate" class="W_input" readonly="true"/></div>
            <div class="rowS" style="height:auto;">
                <label style="display:inline-block;float:left;">产品:</label>
                <div style="float:left;">
                    <span style="display:block;" id="btnSelectProducts">选择产品</span>                                   
                </div>                
            </div>
            <div class="rowS nolabel1"><ul class="ulchk" id="ulSelectedProducts" style="display:none;"></ul></div>
            <div class="rowS nolabel1"><span id="btnRptSubmit">查看报表</span></div>
          
        </div>
        <div style="overflow-x:scroll;padding-bottom:5px;"> 
            <div id="rptPivot">
            </div>
        </div> 
        <div id="rptPivotPager"></div>
        <div id="res2"></div>
    </div>

    <div id="popup_products" style="display:none;">
        <h3>选择要生成报表的产品，如果不选则默认生成有销售数据的所有产品</h3>
        <ul class="ulchk" id="ulProductList">
        
        </ul>
        <div class="s_title spage pager" id="productsListPager" style="display:none;"></div>
    </div>
</div>



